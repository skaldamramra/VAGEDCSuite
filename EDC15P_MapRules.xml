<?xml version="1.0" encoding="utf-8"?>
<!--
  EDC15P Map Detection Rules

  This file defines the rules for detecting and naming maps in EDC15P binary files.
  The detection engine evaluates these rules against potential maps found in the binary.

  Structure:
  <MapRules ecuType="EDC15P" version="2.0">

    <MapRule priority="100" id="unique_id">
      <Description>Human-readable description</Description>

      <Conditions>
        All conditions must match for the rule to apply.

        Basic Conditions:
        <Length>570</Length>                  - Exact length in bytes
        <Length min="500" max="600" />        - Length range

        <XAxisID high="0xC5" />               - X-axis ID high byte (e.g., 0xC5 for 0xC5EC)
        <XAxisID exact="0xC5EC" />            - Exact X-axis ID
        <YAxisID high="0xEC" />               - Y-axis ID high byte

        <XAxisLength>19</XAxisLength>         - X-axis length (number of points)
        <YAxisLength>15</YAxisLength>         - Y-axis length

        <MapSelector numRepeats="10" />       - For maps with selectors (e.g., SOI)

        Advanced Conditions (v2.0):
        <ByteCheck address="y_axis_address" offset="0" expected="0x00" op="eq" />
                                                      - Check raw byte at address
                                                      - address: "y_axis_address", "x_axis_address", "flash_start_address", or "+offset"/"-offset"
                                                      - op: "eq", "ne", "lt", "le", "gt", "ge"

        <AxisValueCheck axis="Y" comparison="lt" value="4000" checkType="max" />
                                                      - Check actual axis data values at runtime
                                                      - axis: "X", "Y", or "Z"
                                                      - comparison: "lt", "le", "gt", "ge", "eq", "ne"
                                                      - checkType: "max" (maximum value) or "min" (minimum value)

        <MapSelectorProperty property="NumRepeats" comparison="eq" value="10" />
                                                      - Check MapSelector properties
                                                      - property: "NumRepeats", "MapIndexes.Length", "MapIndexes[0]"
                                                      - comparison: "eq", "ne", "lt", "le", "gt", "ge"

        <CodeBlock id="1,2,3" type="Manual" />         - Check code block context
                                                      - id: comma-separated list of code block IDs
                                                      - type: "Automatic", "Manual", "4x4"

        Logical Operators:
        <Or>
          <Conditions>...</Conditions>
          <Conditions>...</Conditions>
        </Or>
        <And>
          <Conditions>...</Conditions>
          <Conditions>...</Conditions>
        </And>
      </Conditions>

      <Metadata>
        Properties to assign to the detected map.

        <Category>Detected maps</Category>
        <Subcategory>Fuel</Subcategory>

        <Name>Map Name</Name>                 - Static name
        <Name sequential="true" baseName="Injector duration" codeBlockScoped="true" />
                                              - Sequential naming (e.g., "Injector duration 00", "01")
                                              - codeBlockScoped: if true, counts only within same code block

        <ConditionalTemplate>
          <When conditionType="MapSelectorExists">
            <Template>Smoke limiter {temperature} °C</Template>
          </When>
          <When conditionType="default">
            <Template>Smoke limiter</Template>
          </When>
        </ConditionalTemplate>

        <Correction>0.01</Correction>         - Z-axis correction factor
        <Offset>0</Offset>                    - Z-axis offset

        <XAxis>
          <Description>Engine speed</Description>
          <Units>rpm</Units>
          <Correction>1.0</Correction>
          <Offset>0</Offset>
        </XAxis>

        <YAxis>...</YAxis>
        <ZAxis>...</ZAxis>
      </Metadata>
    </MapRule>
  </MapRules>
-->
<MapRules ecuType="EDC15P" version="2.0">
  
  <!-- Launch Control -->
  <MapRule priority="100" id="launch_control_700">
    <Description>
      Launch control map - 25x14 dimension (700 bytes)
    </Description>
    <Conditions>
      <Length>700</Length>
    </Conditions>
    <Metadata>
      <Category>Detected maps</Category>
      <Subcategory>Misc</Subcategory>
      <Name>Launch control map (XML)</Name>
      <Correction>0.01</Correction>
      <XAxis>
        <Description>Engine speed (rpm)</Description>
        <Units>rpm</Units>
      </XAxis>
      <YAxis>
        <Description>Approx. vehicle speed (km/h)</Description>
        <Units>km/h</Units>
        <Correction>0.156250</Correction>
      </YAxis>
      <ZAxis>
        <Description>IQ limit</Description>
      </ZAxis>
    </Metadata>
  </MapRule>

  <!-- Injector Duration (Multiple Lengths) -->
  <MapRule priority="110" id="injector_duration_generic">
    <Description>
      Injector duration map - Various dimensions
      Handles multiple axis ID combinations: C5/EC, C4/EA, C4/EC
    </Description>
    <Conditions>
      <Or>
        <Conditions><Length>570</Length></Conditions>
        <Conditions><Length>480</Length></Conditions>
        <Conditions><Length>448</Length></Conditions>
        <Conditions><Length>390</Length></Conditions>
        <Conditions><Length>360</Length></Conditions>
        <Conditions><Length>260</Length></Conditions>
        <Conditions><Length>220</Length></Conditions>
        <Conditions><Length>200</Length></Conditions>
        <Conditions><Length>198</Length></Conditions>
        <Conditions><Length>180</Length></Conditions>
        <Conditions><Length>160</Length></Conditions>
      </Or>
      <Or>
        <Conditions>
          <XAxisID high="0xC5" />
          <YAxisID high="0xEC" />
        </Conditions>
        <Conditions>
          <XAxisID high="0xC4" />
          <YAxisID high="0xEA" />
        </Conditions>
        <Conditions>
          <XAxisID high="0xC4" />
          <YAxisID high="0xEC" />
        </Conditions>
      </Or>
    </Conditions>
    <Metadata>
      <Category>Detected maps</Category>
      <Subcategory>Fuel</Subcategory>
      <Name sequential="true" baseName="Injector duration (XML)" codeBlockScoped="true" />
      <Correction>0.023437</Correction>
      <XAxis>
        <Description>Engine speed (rpm)</Description>
        <Units>rpm</Units>
      </XAxis>
      <YAxis>
        <Description>Requested Quantity mg/stroke</Description>
        <Units>mg/st</Units>
        <Correction>0.01</Correction>
      </YAxis>
      <ZAxis>
        <Description>Duration (crankshaft degrees)</Description>
      </ZAxis>
    </Metadata>
  </MapRule>

  <!-- Boost Target (320 bytes) -->
  <MapRule priority="120" id="boost_target_320">
    <Description>
      Boost target map - 10x16 dimension (320 bytes)
      Handles EC/C0 and EA/C0 axis combinations
    </Description>
    <Conditions>
      <Length>320</Length>
      <Or>
        <Conditions>
          <XAxisID high="0xEC" />
          <YAxisID high="0xC0" />
        </Conditions>
        <Conditions>
          <XAxisID high="0xEA" />
          <YAxisID high="0xC0" />
        </Conditions>
      </Or>
    </Conditions>
    <Metadata>
      <Category>Detected maps</Category>
      <Subcategory>Turbo</Subcategory>
      <Name>Boost target map (XML)</Name>
      <XAxis>
        <Description>IQ (mg/stroke)</Description>
        <Units>mg/st</Units>
        <Correction>0.01</Correction>
      </XAxis>
      <YAxis>
        <Description>Engine speed (rpm)</Description>
        <Units>rpm</Units>
      </YAxis>
      <ZAxis>
        <Description>Boost target (mbar)</Description>
      </ZAxis>
    </Metadata>
  </MapRule>

  <!-- Smoke Limiter (Multiple Lengths) -->
  <MapRule priority="130" id="smoke_limiter_generic">
    <Description>
      Smoke limiter (IQ by MAF) - Various dimensions
      Axis IDs: F9/DA or EA/DA
    </Description>
    <Conditions>
      <Or>
        <Conditions><Length>416</Length></Conditions>
        <Conditions><Length>384</Length></Conditions>
      </Or>
      <Or>
        <Conditions>
          <XAxisID high="0xF9" />
          <YAxisID high="0xDA" />
        </Conditions>
        <Conditions>
          <XAxisID high="0xEA" />
          <YAxisID high="0xDA" />
        </Conditions>
      </Or>
    </Conditions>
    <Metadata>
      <Category>Detected maps</Category>
      <Subcategory>Limiters</Subcategory>
      <Name sequential="true" baseName="Smoke limiter (XML)" codeBlockScoped="true" />
      <Correction>0.01</Correction>
      <XAxis>
        <Description>Airflow mg/stroke</Description>
        <Units>mg/st</Units>
        <Correction>0.1</Correction>
      </XAxis>
      <YAxis>
        <Description>Engine speed (rpm)</Description>
        <Units>rpm</Units>
      </YAxis>
      <ZAxis>
        <Description>Maximum IQ (mg)</Description>
      </ZAxis>
    </Metadata>
  </MapRule>

  <!-- ======================================================== -->
  <!-- NEW RULES USING EXTENDED SCHEMA (v2.0)                   -->
  <!-- ======================================================== -->

  <!-- SOI Map with Temperature Naming (using ByteCheck and ConditionalTemplate) -->
  <MapRule priority="140" id="soi_map_448_temp">
    <Description>
      Start of Injection (SOI) map - 16x14 dimension (448 bytes)
      Uses temperature-based naming from MapSelector
    </Description>
    <Conditions>
      <Length>448</Length>
      <XAxisID high="0xC5" />
      <YAxisID high="0xEC" />
      <MapSelector numRepeats="10" />
    </Conditions>
    <Metadata>
      <Category>Detected maps</Category>
      <Subcategory>Fuel</Subcategory>
      <Name sequential="true" baseName="Start of injection (SOI) (XML)" codeBlockScoped="true" />
      <Correction>0.01</Correction>
      <XAxis>
        <Description>Engine speed (rpm)</Description>
        <Units>rpm</Units>
      </XAxis>
      <YAxis>
        <Description>Requested Quantity (mg/st)</Description>
        <Units>mg/st</Units>
        <Correction>0.01</Correction>
      </YAxis>
      <ZAxis>
        <Description>SOI angle (degrees)</Description>
      </ZAxis>
    </Metadata>
  </MapRule>

  <!-- MAP vs MAF Limiter Differentiation (using AxisValueCheck) -->
  <MapRule priority="150" id="limiter_map_generic">
    <Description>
      MAP limiter map - Various dimensions
      Distinguished from MAF limiter by Y-axis max value check
    </Description>
    <Conditions>
      <Or>
        <Conditions><Length>416</Length></Conditions>
        <Conditions><Length>320</Length></Conditions>
      </Or>
      <XAxisID high="0xEC" />
      <YAxisID high="0xDA" />
      <AxisValueCheck axis="Y" comparison="lt" value="4000" checkType="max" />
    </Conditions>
    <Metadata>
      <Category>Detected maps</Category>
      <Subcategory>Limiters</Subcategory>
      <Name>IQ by MAP limiter (XML)</Name>
      <Correction>0.01</Correction>
      <XAxis>
        <Description>Engine speed (rpm)</Description>
        <Units>rpm</Units>
      </XAxis>
      <YAxis>
        <Description>Boost pressure (mbar)</Description>
        <Units>mbar</Units>
        <Correction>1.0</Correction>
      </YAxis>
      <ZAxis>
        <Description>Maximum IQ (mg)</Description>
      </ZAxis>
    </Metadata>
  </MapRule>

  <!-- EGR Map with Zero-Check on Y-axis (using ByteCheck) -->
  <MapRule priority="160" id="egr_map_416_zerocheck">
    <Description>
      EGR map - 13x16 dimension (416 bytes)
      Uses byte check to verify Y-axis data is zero (at least the first byte)
    </Description>
    <Conditions>
      <Length>416</Length>
      <XAxisID high="0xEC" />
      <Or>
        <Conditions>
          <YAxisID high="0xC0" />
        </Conditions>
        <Conditions>
          <YAxisID high="0xE9" />
        </Conditions>
      </Or>
      <ByteCheck address="y_axis_address" offset="0" expected="0x00" op="eq" />
    </Conditions>
    <Metadata>
      <Category>Detected maps</Category>
      <Subcategory>Misc</Subcategory>
      <Name sequential="true" baseName="EGR (XML)" codeBlockScoped="true" />
      <Correction>0.1</Correction>
      <XAxis>
        <Description>IQ (mg/stroke)</Description>
        <Units>mg/st</Units>
        <Correction>0.01</Correction>
      </XAxis>
      <YAxis>
        <Description>Engine speed (rpm)</Description>
        <Units>rpm</Units>
      </YAxis>
      <ZAxis>
        <Description>Mass Air Flow (mg/stroke)</Description>
      </ZAxis>
    </Metadata>
  </MapRule>

  <!-- Smoke Limiter with Temperature Variants (using ConditionalTemplate) -->
  <MapRule priority="170" id="smoke_limiter_416_temp">
    <Description>
      Smoke limiter with temperature-based naming
      Uses conditional templates for dynamic naming based on MapSelector
    </Description>
    <Conditions>
      <Length>416</Length>
      <XAxisID high="0xF9" />
      <YAxisID high="0xDA" />
    </Conditions>
    <Metadata>
      <Category>Detected maps</Category>
      <Subcategory>Limiters</Subcategory>
      <Name sequential="true" baseName="Smoke limiter (XML)" codeBlockScoped="true">
        <ConditionalTemplate>
          <When conditionType="MapSelectorExists">
            <Template>Smoke limiter {temperature} °C (XML)</Template>
          </When>
          <When conditionType="default">
            <Template>Smoke limiter (XML)</Template>
          </When>
        </ConditionalTemplate>
      </Name>
      <Correction>0.01</Correction>
      <XAxis>
        <Description>Airflow (mg/st)</Description>
        <Units>mg/st</Units>
        <Correction>0.1</Correction>
      </XAxis>
      <YAxis>
        <Description>Engine speed (rpm)</Description>
        <Units>rpm</Units>
      </YAxis>
      <ZAxis>
        <Description>Maximum IQ (mg)</Description>
      </ZAxis>
    </Metadata>
  </MapRule>

  <!-- Fuel Temperature Protection Map (using exact AxisID matches) -->
  <MapRule priority="180" id="fuel_temp_protection_200">
    <Description>
      Fuel temperature protection map - 10x10 dimension (200 bytes)
      Uses specific axis ID combinations: C1AE/EC, C178/EC, C1BE/EC
    </Description>
    <Conditions>
      <Length>200</Length>
      <Or>
        <Conditions>
          <XAxisID exact="0xC1AE" />
          <YAxisID high="0xEC" />
        </Conditions>
        <Conditions>
          <XAxisID exact="0xC178" />
          <YAxisID high="0xEC" />
        </Conditions>
        <Conditions>
          <XAxisID exact="0xC1BE" />
          <YAxisID high="0xEC" />
        </Conditions>
      </Or>
    </Conditions>
    <Metadata>
      <Category>Detected maps</Category>
      <Subcategory>Protection</Subcategory>
      <Name>Fuel temperature protection (XML)</Name>
      <Correction>0.1</Correction>
      <XAxis>
        <Description>Fuel temperature (°C)</Description>
        <Units>°C</Units>
        <Correction>1.0</Correction>
      </XAxis>
      <YAxis>
        <Description>Engine speed (rpm)</Description>
        <Units>rpm</Units>
      </YAxis>
      <ZAxis>
        <Description>Fuel correction (%)</Description>
      </ZAxis>
    </Metadata>
  </MapRule>

  <!-- Torque Limiter Map (various sizes) -->
  <MapRule priority="190" id="torque_limiter_generic">
    <Description>
      Torque limiter map - Various dimensions
    </Description>
    <Conditions>
      <Or>
        <Conditions><Length>150</Length><XAxisLength>3</XAxisLength><YAxisLength>25</YAxisLength></Conditions>
        <Conditions><Length>144</Length><XAxisLength>3</XAxisLength><YAxisLength>24</YAxisLength></Conditions>
        <Conditions><Length>138</Length><XAxisLength>3</XAxisLength><YAxisLength>23</YAxisLength></Conditions>
        <Conditions><Length>132</Length><XAxisLength>3</XAxisLength><YAxisLength>22</YAxisLength></Conditions>
        <Conditions><Length>126</Length><XAxisLength>3</XAxisLength><YAxisLength>21</YAxisLength></Conditions>
        <Conditions><Length>120</Length><XAxisLength>3</XAxisLength><YAxisLength>20</YAxisLength></Conditions>
      </Or>
    </Conditions>
    <Metadata>
      <Category>Detected maps</Category>
      <Subcategory>Limiters</Subcategory>
      <Name>Torque limiter (XML)</Name>
      <Correction>0.01</Correction>
      <XAxis>
        <Description>Engine speed (rpm)</Description>
        <Units>rpm</Units>
      </XAxis>
      <YAxis>
        <Description>Atm. pressure (mbar)</Description>
        <Units>mbar</Units>
      </YAxis>
      <ZAxis>
        <Description>Maximum IQ (mg)</Description>
      </ZAxis>
    </Metadata>
  </MapRule>

  <!-- Driver Wish Map -->
  <MapRule priority="200" id="driver_wish_generic">
    <Description>
      Driver wish map - Various dimensions
    </Description>
    <Conditions>
      <Or>
        <Conditions><Length>286</Length><XAxisLength>13</XAxisLength><YAxisLength>11</YAxisLength></Conditions>
        <Conditions><Length>256</Length></Conditions>
        <Conditions><Length>240</Length><XAxisLength>12</XAxisLength><YAxisLength>10</YAxisLength></Conditions>
        <Conditions><Length>216</Length><XAxisLength>12</XAxisLength><YAxisLength>9</YAxisLength></Conditions>
        <Conditions><Length>192</Length><XAxisID high="0xEC" /><YAxisID high="0xC0" /></Conditions>
      </Or>
    </Conditions>
    <Metadata>
      <Category>Detected maps</Category>
      <Subcategory>Misc</Subcategory>
      <Name>Driver wish (XML)</Name>
      <Correction>0.01</Correction>
      <XAxis>
        <Description>Throttle position</Description>
        <Units>TPS %</Units>
        <Correction>0.01</Correction>
      </XAxis>
      <YAxis>
        <Description>Engine speed (rpm)</Description>
        <Units>rpm</Units>
      </YAxis>
      <ZAxis>
        <Description>Requested IQ (mg)</Description>
      </ZAxis>
    </Metadata>
  </MapRule>

  <!-- N75 Duty Cycle Map -->
  <MapRule priority="210" id="n75_duty_cycle_416">
    <Description>
      N75 duty cycle map - 13x16 dimension (416 bytes)
      Axis IDs: EC/EA or EC/E9D4
    </Description>
    <Conditions>
      <Length>416</Length>
      <Or>
        <Conditions>
          <XAxisID high="0xEC" />
          <YAxisID high="0xEA" />
        </Conditions>
        <Conditions>
          <XAxisID high="0xEC" />
          <YAxisID high="0xE9" />
        </Conditions>
      </Or>
    </Conditions>
    <Metadata>
      <Category>Detected maps</Category>
      <Subcategory>Turbo</Subcategory>
      <Name>N75 duty cycle (XML)</Name>
      <Correction>0.01</Correction>
      <XAxis>
        <Description>Engine speed (rpm)</Description>
        <Units>rpm</Units>
      </XAxis>
      <YAxis>
        <Description>Boost demand (mbar)</Description>
        <Units>mbar</Units>
        <Correction>1.0</Correction>
      </YAxis>
      <ZAxis>
        <Description>Duty cycle (%)</Description>
      </ZAxis>
    </Metadata>
  </MapRule>

  <!-- MAF Airmass Correction by Temperature -->
  <MapRule priority="220" id="maf_correction_temp_320">
    <Description>
      MAF airmass correction by temperature - 10x16 dimension (320 bytes)
    </Description>
    <Conditions>
      <Length>320</Length>
      <XAxisID high="0xC5" />
      <YAxisID high="0xEC" />
    </Conditions>
    <Metadata>
      <Category>Detected maps</Category>
      <Subcategory>Air Mass</Subcategory>
      <Name>MAF correction by temperature (XML)</Name>
      <Correction>0.01</Correction>
      <XAxis>
        <Description>Intake air temperature (°C)</Description>
        <Units>°C</Units>
        <Correction>1.0</Correction>
      </XAxis>
      <YAxis>
        <Description>Engine speed (rpm)</Description>
        <Units>rpm</Units>
      </YAxis>
      <ZAxis>
        <Description>MAF correction factor</Description>
      </ZAxis>
    </Metadata>
  </MapRule>

  <!-- Boost Limit Map (200 bytes) -->
  <MapRule priority="230" id="boost_limit_200">
    <Description>
      Boost limit map - 10x10 dimension (200 bytes)
      Axis IDs: C0/EC or C0/EA
    </Description>
    <Conditions>
      <Length>200</Length>
      <XAxisID high="0xC0" />
      <Or>
        <Conditions><YAxisID high="0xEC" /></Conditions>
        <Conditions><YAxisID high="0xEA" /></Conditions>
      </Or>
    </Conditions>
    <Metadata>
      <Category>Detected maps</Category>
      <Subcategory>Limiters</Subcategory>
      <Name>Boost limit map (XML)</Name>
      <XAxis>
        <Description>Engine speed (rpm)</Description>
        <Units>rpm</Units>
      </XAxis>
      <YAxis>
        <Description>Atmospheric pressure (mbar)</Description>
        <Units>mbar</Units>
      </YAxis>
      <ZAxis>
        <Description>Maximum boost pressure (mbar)</Description>
      </ZAxis>
    </Metadata>
  </MapRule>

</MapRules>