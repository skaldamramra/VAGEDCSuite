<?xml version="1.0" encoding="utf-8"?>
<!--
  EDC15P Map Detection Rules

  This file defines the rules for detecting and naming maps in EDC15P binary files.
  The detection engine evaluates these rules against potential maps found in the binary.

  Structure:
  <MapRules ecuType="EDC15P" version="2.0">

    <MapRule priority="100" id="unique_id">
      <Description>Human-readable description</Description>

      <Conditions>
        All conditions must match for the rule to apply.

        Basic Conditions:
        <Length>570</Length>                  - Exact length in bytes
        <Length min="500" max="600" />        - Length range

        <XAxisID high="0xC5" />               - X-axis ID high byte (e.g., 0xC5 for 0xC5EC)
        <XAxisID exact="0xC5EC" />            - Exact X-axis ID
        <YAxisID high="0xEC" />               - Y-axis ID high byte

        <XAxisLength>19</XAxisLength>         - X-axis length (number of points)
        <YAxisLength>15</YAxisLength>         - Y-axis length

        <MapSelector numRepeats="10" />       - For maps with selectors (e.g., SOI)

        Advanced Conditions (v2.0):
        <ByteCheck address="y_axis_address" offset="0" expected="0x00" op="eq" />
                                                      - Check raw byte at address
                                                      - address: "y_axis_address", "x_axis_address", "flash_start_address", or "+offset"/"-offset"
                                                      - op: "eq", "ne", "lt", "le", "gt", "ge"

        <AxisValueCheck axis="Y" comparison="lt" value="4000" checkType="max" />
                                                      - Check actual axis data values at runtime
                                                      - axis: "X", "Y", or "Z"
                                                      - comparison: "lt", "le", "gt", "ge", "eq", "ne"
                                                      - checkType: "max" (maximum value) or "min" (minimum value)

        <MapSelectorProperty property="NumRepeats" comparison="eq" value="10" />
                                                      - Check MapSelector properties
                                                      - property: "NumRepeats", "MapIndexes.Length", "MapIndexes[0]"
                                                      - comparison: "eq", "ne", "lt", "le", "gt", "ge"

        <CodeBlock id="1,2,3" type="Manual" />         - Check code block context
                                                      - id: comma-separated list of code block IDs
                                                      - type: "Automatic", "Manual", "4x4"

        Logical Operators:
        <Or>
          <Conditions>...</Conditions>
          <Conditions>...</Conditions>
        </Or>
        <And>
          <Conditions>...</Conditions>
          <Conditions>...</Conditions>
        </And>
      </Conditions>

      <Metadata>
        Properties to assign to the detected map.

        <Category>Detected maps</Category>
        <Subcategory>Fuel</Subcategory>

        <Name>Map Name</Name>                 - Static name
        <Name sequential="true" baseName="Injector duration" codeBlockScoped="true" />
                                              - Sequential naming (e.g., "Injector duration 00", "01")
                                              - codeBlockScoped: if true, counts only within same code block

        <ConditionalTemplate>
          <When conditionType="MapSelectorExists">
            <Template>Smoke limiter {temperature} °C</Template>
          </When>
          <When conditionType="default">
            <Template>Smoke limiter</Template>
          </When>
        </ConditionalTemplate>

        <Correction>0.01</Correction>         - Z-axis correction factor
        <Offset>0</Offset>                    - Z-axis offset

        <XAxis>
          <Description>Engine speed</Description>
          <Units>rpm</Units>
          <Correction>1.0</Correction>
          <Offset>0</Offset>
        </XAxis>

        <YAxis>...</YAxis>
        <ZAxis>...</ZAxis>
      </Metadata>
    </MapRule>
  </MapRules>
-->
<MapRules ecuType="EDC15P" version="2.0">
  
  <!-- 1. Launch Control -->
  <MapRule priority="100" id="launch_control_700">
    <Description>
      Launch control map - 25x14 dimension (700 bytes)
    </Description>
    <Conditions>
      <Length>700</Length>
    </Conditions>
    <Metadata>
      <Category>Detected maps</Category>
      <Subcategory>Misc</Subcategory>
      <Name>Launch control map (XML)</Name>
      <Correction>0.01</Correction>
      <XAxis>
        <Description>Engine speed (rpm)</Description>
        <Units>rpm</Units>
      </XAxis>
      <YAxis>
        <Description>Approx. vehicle speed (km/h)</Description>
        <Units>km/h</Units>
        <Correction>0.156250</Correction>
      </YAxis>
      <ZAxis>
        <Description>IQ limit</Description>
      </ZAxis>
    </Metadata>
  </MapRule>

  <!-- 2. BIP SOI Correction (Priority before Generic ID) -->
  <MapRule priority="105" id="bip_soi_correction_160">
    <Description>
      BIP SOI Correction Map (zmwBPKorKF) - 10x8 dimension (160 bytes)
      Based on legacy EDC15PFileParser.cs:2555
    </Description>
    <Conditions>
      <Length>160</Length>
      <XAxisLength>10</XAxisLength>
      <YAxisLength>8</YAxisLength>
    </Conditions>
    <Metadata>
      <Category>Detected maps</Category>
      <Subcategory>Fuel</Subcategory>
      <Name>BIP SOI Correction Map (XML)</Name>
      <Correction>0.00390625</Correction>
      <XAxis>
        <Description>Crankshaft degrees</Description>
        <Units>°BTDC</Units>
        <Correction>0.023437</Correction>
        <Offset>-78</Offset>
      </XAxis>
      <YAxis>
        <Description>Engine speed (rpm)</Description>
        <Units>rpm</Units>
      </YAxis>
      <ZAxis>
        <Description>BIP calculation</Description>
      </ZAxis>
    </Metadata>
  </MapRule>

  <!-- 3. Start of Injection (SOI) - Repeat 10 -->
  <MapRule priority="108" id="soi_map_448_temp">
    <Description>
      Start of Injection (SOI) map - 16x14 dimension (448 bytes)
      Based on legacy EDC15PFileParser.cs:1402
    </Description>
    <Conditions>
      <Length>448</Length>
      <MapSelector numRepeats="10" />
    </Conditions>
    <Metadata>
      <Category>Detected maps</Category>
      <Subcategory>Fuel</Subcategory>
      <Name>
        <ConditionalTemplate>
          <When conditionType="MapSelectorExists">
            <Template>Start of injection (SOI) {temperature} deg C (XML)</Template>
          </When>
          <When conditionType="default">
            <Template>Start of injection (SOI) (XML)</Template>
          </When>
        </ConditionalTemplate>
      </Name>
      <Correction>-0.023437</Correction>
      <Offset>78</Offset>
      <XAxis>
        <Description>IQ (mg/stroke)</Description>
        <Units>mg/st</Units>
        <Correction>0.01</Correction>
      </XAxis>
      <YAxis>
        <Description>Engine speed (rpm)</Description>
        <Units>rpm</Units>
      </YAxis>
      <ZAxis>
        <Description>Start position (degrees BTDC)</Description>
      </ZAxis>
    </Metadata>
  </MapRule>

  <!-- 4. Length 448 Corrections (Height, Dynamic, IAT) -->
  <MapRule priority="109" id="injection_height_corr_448">
    <Conditions>
      <Length>448</Length>
      <MapSelector numRepeats="6" />
      <XAxisID high="0xF9" /><YAxisID high="0xEB" />
    </Conditions>
    <Metadata>
      <Category>Detected maps</Category><Subcategory>Fuel</Subcategory>
      <Name sequential="true" baseName="Injection correction map (Height) (XML)" codeBlockScoped="true" />
      <Correction>0.023437</Correction>
      <XAxis><Description>Requested Quantity mg/stroke</Description><Units>mg/st</Units><Correction>0.01</Correction></XAxis>
      <YAxis><Description>Engine speed (rpm)</Description><Units>rpm</Units></YAxis>
      <ZAxis><Description>Duration (crankshaft degrees)</Description></ZAxis>
    </Metadata>
  </MapRule>

  <MapRule priority="110" id="injection_dynamic_advance_448">
    <Conditions>
      <Length>448</Length>
      <MapSelector numRepeats="5" />
      <XAxisID high="0xF9" /><YAxisID high="0xEB" />
    </Conditions>
    <Metadata>
      <Category>Detected maps</Category><Subcategory>Fuel</Subcategory>
      <Name sequential="true" baseName="Injection dynamic advance map (XML)" codeBlockScoped="true" />
      <Correction>0.023437</Correction><Offset>-78</Offset>
      <XAxis><Description>Requested Quantity mg/stroke</Description><Units>mg/st</Units><Correction>0.01</Correction></XAxis>
      <YAxis><Description>Engine speed (rpm)</Description><Units>rpm</Units></YAxis>
      <ZAxis><Description>Duration (crankshaft degrees)</Description></ZAxis>
    </Metadata>
  </MapRule>

  <MapRule priority="111" id="injection_iat_corr_448">
    <Conditions>
      <Length>448</Length>
      <MapSelector numRepeats="4" />
      <XAxisID high="0xF9" /><YAxisID high="0xEB" />
    </Conditions>
    <Metadata>
      <Category>Detected maps</Category><Subcategory>Fuel</Subcategory>
      <Name sequential="true" baseName="Injection correction map (Air Temperature) (XML)" codeBlockScoped="true" />
      <Correction>0.023437</Correction>
      <XAxis><Description>Requested Quantity mg/stroke</Description><Units>mg/st</Units><Correction>0.01</Correction></XAxis>
      <YAxis><Description>Engine speed (rpm)</Description><Units>rpm</Units></YAxis>
      <ZAxis><Description>Duration (crankshaft degrees)</Description></ZAxis>
    </Metadata>
  </MapRule>

  <!-- 5. Injector Duration (ID) - Generic lengths -->
  <MapRule priority="120" id="injector_duration_generic">
    <Description>
      Injector duration map - Various dimensions
      Based on legacy EDC15PFileParser.cs logic for multiple lengths.
      Higher priority rules handle SOI/BIP/etc. to avoid collisions.
    </Description>
    <Conditions>
      <Or>
        <Conditions>
          <Length>570</Length>
          <Or>
            <Conditions><XAxisID high="0xC5" /><YAxisID high="0xEC" /></Conditions>
            <Conditions><XAxisID high="0xC4" /><YAxisID high="0xEA" /></Conditions>
            <Conditions><XAxisID high="0xC4" /><YAxisID high="0xEC" /></Conditions>
          </Or>
        </Conditions>
        <Conditions>
          <Length>480</Length>
          <Or>
            <Conditions><XAxisID high="0xC5" /><YAxisID high="0xEC" /></Conditions>
            <Conditions><XAxisID high="0xC4" /><YAxisID high="0xEA" /></Conditions>
            <Conditions><XAxisID high="0xC4" /><YAxisID high="0xEC" /></Conditions>
          </Or>
        </Conditions>
        <Conditions>
          <Length>448</Length>
          <Or>
            <Conditions><XAxisID high="0xC5" /><YAxisID high="0xEC" /></Conditions>
            <Conditions><XAxisID high="0xC4" /><YAxisID high="0xEA" /></Conditions>
            <Conditions><XAxisID high="0xC4" /><YAxisID high="0xEC" /></Conditions>
          </Or>
        </Conditions>
        <Conditions>
          <Length>390</Length><XAxisLength>13</XAxisLength><YAxisLength>15</YAxisLength>
          <Or>
            <Conditions><XAxisID high="0xC5" /><YAxisID high="0xEC" /></Conditions>
            <Conditions><XAxisID high="0xC4" /><YAxisID high="0xEA" /></Conditions>
            <Conditions><XAxisID high="0xC4" /><YAxisID high="0xEC" /></Conditions>
          </Or>
        </Conditions>
        <Conditions>
          <Length>360</Length><XAxisLength>12</XAxisLength><YAxisLength>15</YAxisLength>
          <Or>
            <Conditions><XAxisID high="0xC5" /><YAxisID high="0xEC" /></Conditions>
            <Conditions><XAxisID high="0xC4" /><YAxisID high="0xEA" /></Conditions>
            <Conditions><XAxisID high="0xC4" /><YAxisID high="0xEC" /></Conditions>
          </Or>
        </Conditions>
        <Conditions>
          <Length>260</Length>
          <Or>
            <Conditions><XAxisID high="0xC5" /><YAxisID high="0xEC" /></Conditions>
            <Conditions><XAxisID high="0xC4" /><YAxisID high="0xEA" /></Conditions>
            <Conditions><XAxisID high="0xC4" /><YAxisID high="0xEC" /></Conditions>
          </Or>
        </Conditions>
        <Conditions>
          <Length>220</Length>
          <Or>
            <Conditions><XAxisID high="0xC5" /><YAxisID high="0xEC" /></Conditions>
            <Conditions><XAxisID high="0xC4" /><YAxisID high="0xEA" /></Conditions>
            <Conditions><XAxisID high="0xC4" /><YAxisID high="0xEC" /></Conditions>
          </Or>
        </Conditions>
        <Conditions>
          <Length>200</Length><AxisValueCheck axis="X" comparison="gt" value="3500" checkType="max" />
          <Or>
            <Conditions><XAxisID high="0xC5" /><YAxisID high="0xEC" /></Conditions>
            <Conditions><XAxisID high="0xC4" /><YAxisID high="0xEA" /></Conditions>
            <Conditions><XAxisID high="0xC4" /><YAxisID high="0xEC" /></Conditions>
          </Or>
        </Conditions>
        <Conditions>
          <Length>198</Length>
          <Or>
            <Conditions><XAxisID high="0xC5" /><YAxisID high="0xEC" /></Conditions>
            <Conditions><XAxisID high="0xC4" /><YAxisID high="0xEA" /></Conditions>
            <Conditions><XAxisID high="0xC4" /><YAxisID high="0xEC" /></Conditions>
          </Or>
        </Conditions>
        <Conditions>
          <Length>180</Length>
          <Or>
            <Conditions><XAxisID high="0xC5" /><YAxisID high="0xEC" /></Conditions>
            <Conditions><XAxisID high="0xC4" /><YAxisID high="0xEA" /></Conditions>
            <Conditions><XAxisID high="0xC4" /><YAxisID high="0xEC" /></Conditions>
          </Or>
        </Conditions>
        <Conditions>
          <Length>160</Length><XAxisLength>8</XAxisLength><YAxisLength>10</YAxisLength>
          <Or>
            <Conditions><XAxisID high="0xC5" /><YAxisID high="0xEC" /></Conditions>
            <Conditions><XAxisID high="0xC4" /><YAxisID high="0xEA" /></Conditions>
            <Conditions><XAxisID high="0xC4" /><YAxisID high="0xEC" /></Conditions>
          </Or>
        </Conditions>
      </Or>
    </Conditions>
    <Metadata>
      <Category>Detected maps</Category>
      <Subcategory>Fuel</Subcategory>
      <Name sequential="true" baseName="Injector duration (XML)" codeBlockScoped="true" />
      <Correction>0.023437</Correction>
      <XAxis>
        <Description>Engine speed (rpm)</Description>
        <Units>rpm</Units>
      </XAxis>
      <YAxis>
        <Description>Requested Quantity mg/stroke</Description>
        <Units>mg/st</Units>
        <Correction>0.01</Correction>
      </YAxis>
      <ZAxis>
        <Description>Duration (crankshaft degrees)</Description>
      </ZAxis>
    </Metadata>
  </MapRule>

  <!-- 6. Boost Target -->
  <MapRule priority="130" id="boost_target_320">
    <Description>
      Boost target map - 10x16 dimension (320 bytes)
    </Description>
    <Conditions>
      <Length>320</Length>
      <Or>
        <Conditions><XAxisID high="0xEC" /><YAxisID high="0xC0" /></Conditions>
        <Conditions><XAxisID high="0xEA" /><YAxisID high="0xC0" /></Conditions>
      </Or>
    </Conditions>
    <Metadata>
      <Category>Detected maps</Category>
      <Subcategory>Turbo</Subcategory>
      <Name>Boost target map (XML)</Name>
      <XAxis>
        <Description>IQ (mg/stroke)</Description>
        <Units>mg/st</Units>
        <Correction>0.01</Correction>
      </XAxis>
      <YAxis>
        <Description>Engine speed (rpm)</Description>
        <Units>rpm</Units>
      </YAxis>
      <ZAxis>
        <Description>Boost target (mbar)</Description>
      </ZAxis>
    </Metadata>
  </MapRule>

  <!-- 7. Smoke Limiter / IQ by MAP/MAF Limiters (Length 416/384) -->
  <MapRule priority="140" id="smoke_limiter_generic">
    <Description>Smoke limiter (IQ by MAF) - Axis IDs: F9/DA or EA/DA</Description>
    <Conditions>
      <Or>
        <Conditions><Length>416</Length></Conditions>
        <Conditions><Length>384</Length><XAxisLength>16</XAxisLength><YAxisLength>12</YAxisLength></Conditions>
      </Or>
      <Or>
        <Conditions><XAxisID high="0xF9" /><YAxisID high="0xDA" /></Conditions>
        <Conditions><XAxisID high="0xEA" /><YAxisID high="0xDA" /></Conditions>
      </Or>
    </Conditions>
    <Metadata>
      <Category>Detected maps</Category>
      <Subcategory>Limiters</Subcategory>
      <Name>
        <ConditionalTemplate>
          <When conditionType="MapSelectorExists">
            <Template>Smoke limiter {temperature} deg C (XML)</Template>
          </When>
          <When conditionType="default">
            <Template>Smoke limiter (XML)</Template>
          </When>
        </ConditionalTemplate>
      </Name>
      <Correction>0.01</Correction>
      <XAxis><Description>Airflow mg/stroke</Description><Units>mg/st</Units><Correction>0.1</Correction></XAxis>
      <YAxis><Description>Engine speed (rpm)</Description><Units>rpm</Units></YAxis>
      <ZAxis><Description>Maximum IQ (mg)</Description></ZAxis>
    </Metadata>
  </MapRule>

  <MapRule priority="145" id="iq_by_map_limiter">
    <Description>IQ by MAP limiter - Axis IDs: EC/DA, Max(Y) under 4000</Description>
    <Conditions>
      <Or>
        <Conditions><Length>416</Length></Conditions>
        <Conditions><Length>320</Length></Conditions>
      </Or>
      <XAxisID high="0xEC" /><YAxisID high="0xDA" />
      <AxisValueCheck axis="Y" comparison="lt" value="4000" checkType="max" />
    </Conditions>
    <Metadata>
      <Category>Detected maps</Category><Subcategory>Limiters</Subcategory>
      <Name>IQ by MAP limiter (XML)</Name>
      <Correction>0.01</Correction>
      <XAxis><Description>Boost pressure</Description><Units>mbar</Units></XAxis>
      <YAxis><Description>Engine speed (rpm)</Description><Units>rpm</Units></YAxis>
      <ZAxis><Description>Maximum IQ (mg)</Description></ZAxis>
    </Metadata>
  </MapRule>

  <!-- 8. EGR Map with Zero-Check -->
  <MapRule priority="160" id="egr_map_generic">
    <Conditions>
      <Or>
        <Conditions><Length>416</Length></Conditions>
        <Conditions><Length>390</Length></Conditions>
        <Conditions><Length>384</Length></Conditions>
        <Conditions><Length>352</Length></Conditions>
      </Or>
      <XAxisID high="0xEC" />
      <Or>
        <Conditions><YAxisID high="0xC0" /></Conditions>
        <Conditions><YAxisID high="0xE9" /></Conditions>
      </Or>
      <ByteCheck address="y_axis_address" offset="0" expected="0x00" op="eq" />
    </Conditions>
    <Metadata>
      <Category>Detected maps</Category><Subcategory>Misc</Subcategory>
      <Name sequential="true" baseName="EGR (XML)" codeBlockScoped="true" />
      <Correction>0.1</Correction>
      <XAxis><Description>IQ (mg/stroke)</Description><Units>mg/st</Units><Correction>0.01</Correction></XAxis>
      <YAxis><Description>Engine speed (rpm)</Description><Units>rpm</Units></YAxis>
      <ZAxis><Description>Mass Air Flow (mg/stroke)</Description></ZAxis>
    </Metadata>
  </MapRule>

  <!-- 9. Driver Wish Map -->
  <MapRule priority="200" id="driver_wish_generic">
    <Conditions>
      <Or>
        <Conditions><Length>286</Length><XAxisLength>13</XAxisLength><YAxisLength>11</YAxisLength></Conditions>
        <Conditions><Length>256</Length></Conditions>
        <Conditions><Length>240</Length><XAxisLength>12</XAxisLength><YAxisLength>10</YAxisLength></Conditions>
        <Conditions><Length>216</Length><XAxisLength>12</XAxisLength><YAxisLength>9</YAxisLength></Conditions>
        <Conditions><Length>192</Length><XAxisID high="0xEC" /><YAxisID high="0xC0" /></Conditions>
      </Or>
    </Conditions>
    <Metadata>
      <Category>Detected maps</Category><Subcategory>Misc</Subcategory>
      <Name>Driver wish (XML)</Name>
      <Correction>0.01</Correction>
      <XAxis><Description>Throttle position</Description><Units>TPS %</Units><Correction>0.01</Correction></XAxis>
      <YAxis><Description>Engine speed (rpm)</Description><Units>rpm</Units></YAxis>
      <ZAxis><Description>Requested IQ (mg)</Description></ZAxis>
    </Metadata>
  </MapRule>

  <!-- 10. N75 Duty Cycle Map -->
  <MapRule priority="210" id="n75_duty_cycle_generic">
    <Conditions>
      <Or>
        <Conditions><Length>416</Length></Conditions>
        <Conditions><Length>352</Length></Conditions>
      </Or>
      <XAxisID high="0xEC" />
      <Or>
        <Conditions><YAxisID high="0xEA" /></Conditions>
        <Conditions><YAxisID exact="0xE9D4" /></Conditions>
      </Or>
    </Conditions>
    <Metadata>
      <Category>Detected maps</Category><Subcategory>Turbo</Subcategory>
      <Name>N75 duty cycle (XML)</Name>
      <Correction>-0.01</Correction><Offset>100</Offset>
      <XAxis><Description>IQ (mg/stroke)</Description><Units>mg/st</Units><Correction>0.01</Correction></XAxis>
      <YAxis><Description>Engine speed (rpm)</Description><Units>rpm</Units></YAxis>
      <ZAxis><Description>Duty cycle %</Description></ZAxis>
    </Metadata>
  </MapRule>

  <!-- 11. Fuel Temperature Protection -->
  <MapRule priority="220" id="fuel_temp_protection_200">
    <Conditions>
      <Length>200</Length>
      <Or>
        <Conditions><XAxisID exact="0xC1AE" /><YAxisID high="0xEC" /></Conditions>
        <Conditions><XAxisID exact="0xC178" /><YAxisID high="0xEC" /></Conditions>
        <Conditions><XAxisID exact="0xC1BE" /><YAxisID high="0xEC" /></Conditions>
      </Or>
    </Conditions>
    <Metadata>
      <Category>Detected maps</Category><Subcategory>Protection</Subcategory>
      <Name>Fuel temperature protection (XML)</Name>
      <Correction>0.0001</Correction>
      <XAxis><Description>Engine speed (rpm)</Description><Units>rpm</Units></XAxis>
      <YAxis><Description>Fuel temperature (deg C)</Description><Units>deg C</Units><Correction>0.1</Correction><Offset>-273.1</Offset></YAxis>
      <ZAxis><Description>Correction</Description></ZAxis>
    </Metadata>
  </MapRule>

  <!-- 12. Boost Limit Map -->
  <MapRule priority="230" id="boost_limit_200">
    <Conditions>
      <Or>
        <Conditions><Length>200</Length></Conditions>
        <Conditions><Length>180</Length></Conditions>
      </Or>
      <XAxisID high="0xC0" />
      <Or>
        <Conditions><YAxisID high="0xEC" /></Conditions>
        <Conditions><YAxisID high="0xEA" /></Conditions>
      </Or>
    </Conditions>
    <Metadata>
      <Category>Detected maps</Category><Subcategory>Limiters</Subcategory>
      <Name>Boost limit map (XML)</Name>
      <XAxis><Description>Engine speed (rpm)</Description><Units>rpm</Units></XAxis>
      <YAxis><Description>Atmospheric pressure (mbar)</Description><Units>mbar</Units></YAxis>
      <ZAxis><Description>Maximum boost pressure (mbar)</Description></ZAxis>
    </Metadata>
  </MapRule>

</MapRules>
